<h2 class="pb-1">Chat Messages</h2>

<div class="row no-gutters mb-1">
  <div class="col d-flex justify-content-between no-gutters align-items-center">
    <div class="col-md-9">
      <form [formGroup]="searchForm1" (ngSubmit)="search(0)">
        <div class="input-group">
          <input type="text" class="form-control border-right-0" formControlName="label" placeholder="Filter by chat label"/>
          <div class="input-group-append">
            <div class="btn-group">
              <button type="submit" class="btn btn-primary dropdown-radius" (click)="type=2; search(0)">Search</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="row no-gutters mb-1">
  <div class="col d-flex justify-content-between no-gutters align-items-center">
    <div class="col-md-9">
      <form [formGroup]="searchForm2" (ngSubmit)="search(0)">
        <div class="input-group">
          <input type="text" class="form-control border-right-0" formControlName="group_id" placeholder="Filter by group ID"/>
          <div class="input-group-append">
            <div class="btn-group">
              <button type="submit" class="btn btn-primary dropdown-radius" (click)="type=3; search(0)">Search
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="row no-gutters mb-4">
  <div class="col d-flex justify-content-between no-gutters align-items-center">
    <div class="col-md-9">
      <form [formGroup]="searchForm3" (ngSubmit)="search(0)">
        <div class="input-group">
          <input type="text" class="form-control border-right-0" formControlName="user_id_one" placeholder="Filter by user ID 1"/>
          <div class="input-group-append">
          <span class="input-group-text" (click)="f3.user_id_one.setValue(systemUserId);">
            <img class="mr-1" src="/static/svg/purple-cog-1.svg" alt="" width="20" height=""></span>
          </div>
          <input type="text" class="form-control border-right-0" formControlName="user_id_two" placeholder="Filter by user ID 2"/>
          <div class="input-group-append">
            <div class="btn-group">
              <button type="submit" class="btn btn-primary dropdown-radius" (click)="type=4; search(0)">Search
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="col-md-3 justify-content-end text-right">
      <div class="btn-group page-btns" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-secondary" (click)="search(0)" [disabled]="messages.length === 0">
          <img src="/static/svg/page-first.svg" alt="" width="20" height=""></button>
        <!--            <button type="button" class="btn btn-outline-secondary" (click)="search(-1)" [disabled]="prev_cursor === ''"><img src="/static/svg/page-prev.svg" alt="" width="20" height=""></button>-->
        <button type="button" class="btn btn-outline-secondary" (click)="search(1)" [disabled]="nextCursor === ''"><img
          src="/static/svg/page-next.svg" alt="" width="20" height=""></button>
      </div>
    </div>
  </div>
</div>


<h6 *ngIf="messages.length != 0 && error === '' && type==2">Showing results by chat label: {{f1.label}}</h6>
<h6 *ngIf="messages.length != 0 && error === '' && type==3">Showing results by group ID:
  <a [routerLink]="['/groups', f2.group_id.value]" style="width: 100%">{{f2.group_id.value}}</a>
</h6>
<h6 *ngIf="messages.length != 0 && error === '' && type==4">Showing results by user IDs:
  <a [routerLink]="['/accounts', f3.user_id_one.value]" style="width: 100%">{{f3.user_id_one.value}}</a>,
  <a [routerLink]="['/accounts', f3.user_id_two.value]" style="width: 100%">{{f3.user_id_two.value}}</a>
</h6>

<ngb-alert [dismissible]="false" type="danger" class="mb-3" *ngIf="error">
  <img src="/static/svg/red-triangle.svg" alt="" width="16" height="" class="mr-2">
  <h6 class="mr-2 d-inline font-weight-bold">Error when querying messages: {{error}}</h6>
</ngb-alert>

<div class="row no-gutters">
  <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
    <thead class="thead-light">
    <tr>
      <th style="width: 60px">Code</th>
      <th style="width: 320px">Sender ID</th>
      <th style="width: 150px">Username</th>
      <th>Content</th>
      <th style="width: 180px">Create Time</th>
      <th style="width: 90px" *ngIf="deleteAllowed()">Remove</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngIf="messages.length === 0">
      <td colSpan="6" class="text-muted">No messages found.</td>
    </tr>

    <ng-template ngFor let-item [ngForOf]="messages" let-i="index">
      <tr>
        <td>{{item.code}}</td>
        <td (click)="viewAccount(item)">{{item.sender_id}}</td>
        <td (click)="viewAccount(item)" style="text-overflow:ellipsis; overflow: hidden;">{{item.username}}</td>
        <td id="item_{{i}}" (click)="viewMessage(i)" style="white-space: nowrap; text-overflow:ellipsis; overflow: hidden;">â–¶ {{item.content}}</td>
        <td>{{item.create_time}}</td>
        <td *ngIf="deleteAllowed() && item.sender_id === systemUserId"></td>
        <td *ngIf="deleteAllowed() && item.sender_id !== systemUserId" class="text-center">
          <button type="button" class="btn btn-sm btn-danger" (click)="deleteMessage($event, i, item);">Delete</button>
        </td>
      </tr>
      <tr>
        <td id="msg_{{i}}" colspan="6" style="display: none;">
          {{item.content}}
        </td>
      </tr>
    </ng-template>
    </tbody>
  </table>
</div>

<ngb-alert [dismissible]="false" type="danger" *ngIf="deleteError">
  <img src="/static/svg/red-triangle.svg" alt="" width="16" height="" class="mr-2">
  <h6 class="mr-2 d-inline font-weight-bold">Failed to delete data.</h6>
  <p class="mb-0 pl-4">{{deleteError}}</p>
</ngb-alert>

<ngb-alert type="success" *ngIf="deleteSuccess" [dismissible]="true" (close)="deleteSuccess=false">
  <img src="/static/svg/green-tick.svg" alt="" width="16" height="" class="mr-2">
  <h6 class="mr-2 d-inline font-weight-bold">{{total_deleted}} messages successfully deleted.</h6>
</ngb-alert>

<div class="d-flex justify-content-between align-items-center" role="alert">
  <ng-template #confirmDelete let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Delete messages</h5>
      <button type="button" class="close" aria-describedby="modal-title" (click)="modal.dismiss()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="d-flex flex-column justify-content-center">
        <form [formGroup]="confirmDeleteForm">
          <div class="mt-2"><p><b>Choose how many days to retain: </b>
            <input type="number" style="width: 80px;" value="30" min="0" formControlName="days" />
          </p></div>
          <input type="text" class="form-control" id="delete-confirm" placeholder="Type 'DELETE' to confirm" formControlName="delete" [ngClass]="{'is-invalid': f.delete.touched && f.delete.invalid}" />
        </form>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
      <button type="button" class="btn btn-danger" [disabled]="f.delete.invalid" (click)="modal.close()">DELETE</button>
    </div>
  </ng-template>
  <button [disabled]="deleting" (click)="openDeleteDataModal(confirmDelete)" type="button" class="btn btn-danger">Delete old messages</button>
</div>

